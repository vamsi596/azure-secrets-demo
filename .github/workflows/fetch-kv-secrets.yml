name: Fetch Secrets from Key Vault

on:
  workflow_dispatch:

jobs:
  fetch-and-create-secret:
    runs-on: ubuntu-latest

    env:
      KEYVAULT_NAME: practice-vault

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Fetch secrets from Key Vault
        run: |
          echo "DB_USER=$(az keyvault secret show --vault-name $KEYVAULT_NAME --name DB-USER --query value -o tsv)" >> $GITHUB_ENV
          echo "DB_PASS=$(az keyvault secret show --vault-name $KEYVAULT_NAME --name DB-PASS --query value -o tsv)" >> $GITHUB_ENV
          echo "API_KEY=$(az keyvault secret show --vault-name $KEYVAULT_NAME --name API-KEY --query value -o tsv)" >> $GITHUB_ENV

      - name: Replace placeholders in JSON
        run: |
          cp secrets.template.json secrets.json
          sed -i "s|__DB_USER__|${DB_USER}|g" secrets.json
          sed -i "s|__DB_PASS__|${DB_PASS}|g" secrets.json
          sed -i "s|__API_KEY__|${API_KEY}|g" secrets.json

      - name: Create temporary Kubernetes Secret
        run: |
          kubectl create secret generic temp-secret \
            --from-file=secrets.json \
            --dry-run=client -o yaml > temp-secret.yaml

      - name: Verify Secret YAML
        run: cat temp-secret.yaml
